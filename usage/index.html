<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Usage - Waffles</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Usage";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-75603-16', 'waffles.terrarum.net');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Waffles</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../guides/install/">Installation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../concepts/">Concepts</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Usage</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#how-to-use-waffles">How to Use Waffles</a></li>
                
                    <li><a class="toctree-l4" href="#execution-methods">Execution Methods</a></li>
                
                    <li><a class="toctree-l4" href="#wafflescripts">Wafflescripts</a></li>
                
                    <li><a class="toctree-l4" href="#data-roles-and-profiles-drp">Data, Roles, and Profiles (DRP)</a></li>
                
                    <li><a class="toctree-l4" href="#waffleseeds">Waffleseeds</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../modules/">Modules</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Functions</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/system/">system</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/catalog/">catalog</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/options/">options</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/resource/">resource</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/template/">template</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/augeas/">augeas</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/consul/">consul</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/mysql/">mysql</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../functions/rabbitmq/">rabbitmq</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Variables</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../variables/environment/">environment</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../variables/system/">system</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Guides</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/deploying-a-mysql-server/">Deploying a MySQL Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/deploying-a-mysql-galera-cluster/">Deploying a MySQL Galera Cluster</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/deploying-a-consul-cluster/">Deploying a Consul Cluster</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/override-data/">Overriding Data</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/referencing-data-from-data/">Referencing Data from Data</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/testing-with-test-kitchen/">Testing Waffles with Test Kitchen</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/waffles-and-lxc/">Waffles and LXC</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../guides/waffles-and-terraform/">Waffles and Terraform</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Resources</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/">Internals</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/apache.section/">apache.section</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/apache.setting/">apache.setting</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/apt.key/">apt.key</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/apt.pkg/">apt.pkg</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/apt.ppa/">apt.ppa</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/apt.source/">apt.source</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.aptconf/">augeas.aptconf</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.cron/">augeas.cron</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.file_line/">augeas.file_line</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.generic/">augeas.generic</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.host/">augeas.host</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.ini/">augeas.ini</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.json_array/">augeas.json_array</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.json_dict/">augeas.json_dict</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.mail_alias/">augeas.mail_alias</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.shellvar/">augeas.shellvar</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/augeas.ssh_authorized_key/">augeas.ssh_authorized_key</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/consul.check/">consul.check</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/consul.service/">consul.service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/consul.template/">consul.template</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/consul.watch/">consul.watch</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/cron.entry/">cron.entry</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/dpkg.debconf/">dpkg.debconf</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/file.ini/">file.ini</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/file.line/">file.line</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/git.repo/">git.repo</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/ip6tables.rule/">ip6tables.rule</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/iptables.rule/">iptables.rule</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/keepalived.global_defs/">keepalived.global_defs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/keepalived.vrrp_instance/">keepalived.vrrp_instance</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/keepalived.vrrp_script/">keepalived.vrrp_script</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/keepalived.vrrp_sync_group/">keepalived.vrrp_sync_group</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/mysql.database/">mysql.database</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/mysql.grant/">mysql.grant</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/mysql.user/">mysql.user</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.events/">nginx.events</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.global/">nginx.global</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.http/">nginx.http</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.if/">nginx.if</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.location/">nginx.location</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.map/">nginx.map</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.server/">nginx.server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/nginx.upstream/">nginx.upstream</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/os.directory/">os.directory</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/os.file/">os.file</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/os.groupadd/">os.groupadd</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/os.symlink/">os.symlink</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/os.useradd/">os.useradd</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/python.pip/">python.pip</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/python.virtualenv/">python.virtualenv</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/rabbitmq.cluster_nodes/">rabbitmq.cluster_nodes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/rabbitmq.config_settings/">rabbitmq.config_settings</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/rabbitmq.policy/">rabbitmq.policy</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/rabbitmq.user_permissions/">rabbitmq.user_permissions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/rabbitmq.user/">rabbitmq.user</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/rabbitmq.vhost/">rabbitmq.vhost</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/service.sysv/">service.sysv</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/service.upstart/">service.upstart</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../resources/sudo.cmd/">sudo.cmd</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Waffles</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Usage</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/jtopjian/waffles" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="how-to-use-waffles">How to Use Waffles</h1>
<div class="toc">
<ul>
<li><a href="#how-to-use-waffles">How to Use Waffles</a><ul>
<li><a href="#execution-methods">Execution Methods</a></li>
<li><a href="#wafflescripts">Wafflescripts</a></li>
<li><a href="#data-roles-and-profiles-drp">Data, Roles, and Profiles (DRP)</a><ul>
<li><a href="#the-site-directory">The "site" directory</a></li>
<li><a href="#data">Data</a><ul>
<li><a href="#referencing-data">Referencing Data</a></li>
<li><a href="#data-structure">Data Structure</a></li>
<li><a href="#hierarchial-data">Hierarchial Data</a></li>
<li><a href="#profile-data">Profile Data</a></li>
</ul>
</li>
<li><a href="#profiles">Profiles</a><ul>
<li><a href="#profile-structure">Profile Structure</a></li>
<li><a href="#git-profiles">Git Profiles</a></li>
<li><a href="#the-hosts-profile">The Hosts Profile</a></li>
<li><a href="#stacks">Stacks</a></li>
</ul>
</li>
<li><a href="#roles">Roles</a></li>
<li><a href="#applying-roles">Applying Roles</a><ul>
<li><a href="#local-execution">Local Execution</a></li>
<li><a href="#remote-execution-push">Remote Execution (push)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#waffleseeds">Waffleseeds</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="execution-methods">Execution Methods</h2>
<p>You can run Waffles in two different ways:</p>
<ul>
<li>Wafflescripts: a convenient way to create simple shell scripts that take advantage of Waffles's rich library of functions and resources.</li>
<li>Data, Roles, and Profiles (DRP): enables the design of reusable components that can then be composed into various roles. These roles can then be pushed to remote nodes for easy provisioning.</li>
<li>Waffleseeds: The same as DRP, but bundles all files that are part of a role into a single, executable file.</li>
</ul>
<h2 id="wafflescripts">Wafflescripts</h2>
<p>Creating a Wafflescript is the easist way to get up and running with Waffles. However, Wafflescripts are not as flexible or scalable as Data, Roles, and Profiles. In addition, Wafflescripts can only be run locally at this time.</p>
<p>Wafflescripts look like any other shell script. Simply create a file with the <code>wafflescript</code> shebang and then execute one or more Waffles functions and resources as well as any other shell code:</p>
<pre><code class="shell">#!/usr/local/bin/wafflescript

log.info &quot;Hello, World!&quot;
apt.pkg --package memcached --version latest
echo &quot;Goodbye, World!&quot;
</code></pre>

<h2 id="data-roles-and-profiles-drp">Data, Roles, and Profiles (DRP)</h2>
<h3 id="the-site-directory">The "site" directory</h3>
<p>All of your Data, Roles, and Profiles will go under the "site" directory. By default, this directory is <code>waffles/site</code>, but you can change it by setting <code>WAFFLES_SITE_DIR</code> in either:</p>
<ul>
<li>The environment (environment variable)</li>
<li>The <code>waffles/waffles.conf</code> file</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a href="../guides/environment-vars">Environment Variables</a> Guide for more information.</p>
</div>
<h3 id="data">Data</h3>
<p>Data files are stored in <code>site/data</code>. They're regular Bash scripts and it's only by convention that you store "data", and not programming logic, in these files.</p>
<p>So what is "data"? It's all of the settings that make your site or environment unique:</p>
<ul>
<li>IP Addresses</li>
<li>Usernames, UIDs, GIDs</li>
<li>Package versions</li>
<li>Firewall rules</li>
</ul>
<p>A Data file called <code>memcached.sh</code> could look like this:</p>
<pre><code class="shell">data_memcached_listen=&quot;0.0.0.0&quot;

declare -Ag data_user_info
data_user_info=(
  [jdoe|uid]=999
  [jdoe|gid]=999
  [jdoe|comment]=&quot;John doe&quot;
  [jdoe|homedir]=&quot;/home/jdoe&quot;
  [jdoe|shell]=&quot;/bin/bash&quot;
  [jdoe|create_home]=true
)
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can name the variables anything you'd like, though the Waffles naming convention is to start each variable with <code>data_</code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Bash associative arrays <em>must</em> be declared as global variables. This is because all files are sourced inside a Bash function and, for whatever reason, associative arrays are not visible outside of a function (unlike all other Bash variable types).</p>
</div>
<h4 id="referencing-data">Referencing Data</h4>
<p>Once you've created some "data" in a data file, you can refer to it by doing the following:</p>
<pre><code class="shell">waffles.data memcached

echo $data_memcached_listen
</code></pre>

<p><code>waffles.data</code> is a function that takes a single argument: the name of a data file.</p>
<h4 id="data-structure">Data Structure</h4>
<p>The placement of data files is flexible. You can do any of the following:</p>
<pre><code class="shell">waffles.data common       =&gt; site/data/common.sh
waffles.data common       =&gt; site/data/common/init.sh
waffles.data common/users =&gt; site/data/common/users.sh
waffles.data memcached    =&gt; site/data/memcached.sh
waffles.data memcached    =&gt; site/data/memcached/init.sh
</code></pre>

<h4 id="hierarchial-data">Hierarchial Data</h4>
<p>By declaring multiple data files in your role, you can create a hierarchy of data. For example:</p>
<pre><code class="shell">waffles.data common
waffles.data memcached
</code></pre>

<p>In the above, common settings that are applicable to <em>any</em> role are stored in <code>site/data/common.sh</code>. Only data relevant to the <code>memcached</code> service is stored in <code>site/data/memcached.sh</code>.</p>
<p>You can even declare the same variable in both data files. The data file declaring it last will overwrite all previous declarations and win.</p>
<p>Finally, you can reference data from a previously declared data file. You can't, however, reference variables in data files <em>before</em> they are declared. To clarify: <code>site/data/memcached.sh</code> can reference data from <code>site/data/common.sh</code>, but not vice versa.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a href="../guides/referencing-data-from-data">Referencing Data from Data</a> and <a href="../guides/override-data">Overriding Data</a> Guides for more information.</p>
</div>
<h4 id="profile-data">Profile Data</h4>
<p>Profile-specific data can be stored in <code>profile_name/data.sh</code>. This enables data unique to the profile, but generic to the site, to be bundled within the profile and stored in a repository outside of <code>$WAFFLES_SITE_DIR</code>.</p>
<p>To use profile data, simply declare it as you would with site data:</p>
<pre><code class="shell">waffles.data memcached
</code></pre>

<p>When both site and profile data exists, the site data will be referenced <em>first</em>. This means that you can create variables in the site data and use them in the profile data. This might seem counter-intuitive, but allows the ability to embed site-specific data into profile-wide data structures:</p>
<pre><code class="shell">declare -Ag data_openstack_keystone_settings=(
  [DEFAULT/admin_token]=&quot;$set_this_in_the_site_data.sh&quot;
  [DEFAULT/debug]=&quot;true&quot;
  [DEFAULT/verbose]=&quot;true&quot;
)
</code></pre>

<h3 id="profiles">Profiles</h3>
<p>Profiles are small snippets of bash scripts stored under <code>site/profiles</code>. They are meant to be distinct units of work that accomplish a single task.</p>
<p>For example, you may have a Profile that installs the <code>memcached</code> package, a Profile that configures <code>/etc/memcached.conf</code>, and a Profile that sets up the <code>memcached</code> daemon. Or you may choose to have a single Profile that does all three tasks. Waffles does not enforce any rules to how you design your Profiles.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It's possible to call Profiles from other Profiles, but that's not an encouraged practice.</p>
</div>
<h4 id="profile-structure">Profile Structure</h4>
<p>Profiles have a standard structure to them:</p>
<pre><code class="shell">site/profiles/consul/
├── data.sh
├── files
│   └── consul.conf
└── scripts
    ├── install_linux.sh
    └── server.sh
</code></pre>

<p>Static files go under <code>files</code> while scripts go under <code>scripts</code>. Profile-specific data can be stored in <code>data.sh</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using the <code>os.file</code> resource, you can use the <code>--source</code> option to copy files to their destination. The <code>--source</code> option is able to reference any file on the system. It's recommended to use <code>$profile_files/file.conf</code> when "sourcing" a file.</p>
</div>
<p>The <code>waffles.profile</code> function is similar to <code>waffles.data</code>: it takes a single argument, which is the name of a profile. The following translations are possible:</p>
<pre><code class="shell">waffles.profile common/users    =&gt; site/profiles/common/scripts/users.sh
waffles.profile common/packages =&gt; site/profiles/common/scripts/packages.sh
waffles.profile memcached       =&gt; site/profiles/memcached/scripts/init.sh
waffles.profile memcached/utils =&gt; site/profiles/memcached/scripts/utils.sh
</code></pre>

<h4 id="git-profiles">Git Profiles</h4>
<p>Waffles supports the ability to store profiles in a git repository. To use this feature, include the following in the role:</p>
<pre><code class="shell">git.profile https://github.com/jtopjian/waffles-profile-openstack --branch dev
</code></pre>

<p>This will clone https://github.com/jtopjian/waffles-profile-openstack as <code>$WAFFLES_SITE_DIR/profiles/openstack</code> with the <code>dev</code> branch checked out.</p>
<p>Once the above is declared, profile scripts can be referenced like normal:</p>
<pre><code class="shell">waffles.profile openstack/keystone
</code></pre>

<p>Profile names are based on the repository name. Waffles will split the repository name by dashes (<code>-</code>) and use the last portion of the name.</p>
<p><code>git.profile</code> has the following syntax:</p>
<pre><code>git.profile https://github.com/jtopjian/waffles-profile-openstack
git.profile https://github.com/jtopjian/waffles-profile-openstack --branch dev
git.profile https://github.com/jtopjian/waffles-profile-openstack --tag 0.5.1
git.profile https://github.com/jtopjian/waffles-profile-openstack --commit 023a83
</code></pre>

<p>If you are pushing to a remote node and the remote node does not have access to the git repository, you can check out the repository on the Waffles "server" and then push it to the remote node by using <code>--push</code>:</p>
<pre><code>git.profile https://github.com/jtopjian/waffles-profile-openstack --branch dev --push true
</code></pre>

<h4 id="the-hosts-profile">The Hosts Profile</h4>
<p>Waffles supports an optional special profile called <code>host_files</code>, located at <code>site/profiles/host_files</code>. The purpose of this profile is to provide an area where files and scripts specific to individual hosts can be stored. This is beneficial because, normally, the entire profile is copied to each node that uses the profile. If you are storing files such as SSL certs in a profile, all SSL certs would be then copied to all hosts that share the profile.</p>
<p>The <code>host_files</code> profile has the following structure:</p>
<pre><code class="shell">site/profiles/host_files/
├── mysql-01
│   └── files
│       ├── mysql-01.crt
│       └── mysql-01.key
├── mysql-02
│   └── files
│       ├── mysql-02.crt
│       └── mysql-02.key
└── rabbit-01
    ├── files
    │   ├── rabbit-01.crt
    │   └── rabbit-01.key
    └── scripts
        └── custom.sh
</code></pre>

<p>Each subdirectory of the <code>host_files</code> profile is an individual host or node, named after the hostname (not FQDN). The directory of these subdirectories is like a normal profile with the usual <code>files</code> and <code>scripts</code> subdirectories.</p>
<p>Inside your role, you can enable this special profile by doing:</p>
<pre><code class="shell">waffles.profile host_files
</code></pre>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This means that <code>host_files</code> is a reserved name.</p>
</div>
<h4 id="stacks">Stacks</h4>
<p>Stacks are a way of combining profile scripts within a profile. For example, let's say you create a <a href="http://consul.io">Consul</a> profile that has the following scripts:</p>
<ul>
<li><code>scripts/install.sh</code></li>
<li><code>scripts/configure_client.sh</code></li>
<li><code>scripts/configure_server.sh</code></li>
</ul>
<p>In each role, you find yourself applying the same thing over and over:</p>
<pre><code class="shell">waffles.data consul
waffles.profile consul/install
waffles.profile consul/configure_client
</code></pre>

<p>To minimize the amount of repeated code, create a stack in the profile called <code>profiles/consul/stacks/client.sh</code> with the contents:</p>
<pre><code class="shell">waffles.data consul
waffles.profile consul/install
waffles.profile consul/configure_client
</code></pre>

<p>And in your role, have:</p>
<pre><code class="shell">waffles.stack consul/client
</code></pre>

<h3 id="roles">Roles</h3>
<p>A "role" is a name that identifies a unique configuration set. Examples of roles could be:</p>
<ul>
<li><code>memcached</code></li>
<li><code>memcached_apt</code></li>
<li><code>memcached_yum</code></li>
<li><code>memcached_yum_lxc</code></li>
<li><code>memcached_and_redis</code></li>
</ul>
<p>Role names are up to you -- just make sure <em>you</em> understand that applying the <code>memcached_yum_lxc</code> role to an Ubuntu-based KVM virtual machine probably won't work.</p>
<p>Roles are defined in <code>site/roles</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A role is really just another Bash script. It's possible to use Waffles to organize a collection of deployment scripts simply by placing them under the <code>site/roles</code> directory.</p>
</div>
<p>To use roles most effectively, think of them as glue between <em>data</em> and <em>profiles</em>:</p>
<p>A very simple role could look like this:</p>
<pre><code class="shell"># Reads data from site/data/common.sh
waffles.data common

# Reads data from site/data/memcached.sh
waffles.data memcached

# Reads site/profiles/common/scripts/users.sh
waffles.profile common/users

# Reads site/profiles/common/scripts/packages.sh
waffles.profile common/packages

# Reads site/profiles/memcached/scripts/init.sh
waffles.profile memcached
</code></pre>

<h3 id="applying-roles">Applying Roles</h3>
<p>Waffles supports two ways of applying roles:</p>
<h4 id="local-execution">Local Execution</h4>
<p>You can run <code>waffles.sh</code> directly on a node and Waffles will apply the role to that node. For example:</p>
<pre><code class="shell">$ waffles.sh -r memcached
</code></pre>

<p>This is most useful when you copy the entire contents of the <code>waffles</code> directory to a node, log into the node, and manually run <code>waffles.sh</code>.</p>
<h4 id="remote-execution-push">Remote Execution (push)</h4>
<p>It's possible to run Waffles on a remote node by pushing the configuration via rsync and SSH. To do this, use the <code>-s &lt;server&gt;</code> flag. For example:</p>
<pre><code class="shell">$ waffles.sh -s www.example.com -r web
</code></pre>

<p>The benefit of this method is that only the data and profiles referenced in the role will be copied to the remote node. So if you have several other profiles, such as for MySQL or RabbitMQ, those profiles will not be copied to a node acting as a <code>memcached</code> node.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this time, both the Waffles server and destination node must have rsync and installed.</p>
</div>
<h2 id="waffleseeds">Waffleseeds</h2>
<p>Waffleseeds follow the same principles as Data, Roles, and Profiles with one key difference: Instead of executing the Role in real-time, all files that the role needs are bundled into a single, executable file. This file can then be copied to any remote node and executed.</p>
<p>To compile a Waffleseed file, do the following:</p>
<pre><code class="shell">$ waffleseed.sh -r web
</code></pre>

<p>The result will be a file called <code>web.ws</code> in the current directory.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../modules/" class="btn btn-neutral float-right" title="Modules"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../concepts/" class="btn btn-neutral" title="Concepts"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../concepts/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../modules/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
